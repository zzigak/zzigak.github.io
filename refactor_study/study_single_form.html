<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refactoring Study - Compare Code</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css">
    <style>
        /* Mobile detection for study page */
        .mobile-block {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 1.5rem;
            max-width: 90%;
            width: 400px;
            box-shadow: var(--shadow-sm);
            z-index: 10000;
        }
        
        .mobile-block h3 {
            font-size: 1.125rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }
        
        .mobile-block p {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        
        @media (max-width: 768px), (pointer: coarse) and (hover: none) {
            .mobile-block {
                display: block;
            }
            
            .study-container {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Block Message -->
    <div class="mobile-block">
        <h3>üñ•Ô∏è Desktop Required</h3>
        <p>This study needs a larger screen to display three code panels side-by-side.</p>
        <p>Please continue on a desktop or laptop computer.</p>
    </div>
    
    <div class="study-container">
        <header class="study-header">
            <div class="progress-info">
                <span class="progress-text">Question <span id="currentQuestion">1</span> of 10</span>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
            <div class="participant-info">
                <span>Participant: <strong id="participantId">-</strong></span>
                <span class="timer" id="timer">00:00</span>
            </div>
            <div class="controls-section">
                <button class="btn btn-secondary" id="instructionsBtn" style="margin-right: 1rem; padding: 0.5rem 1rem; font-size: 0.9rem;">üìñ Instructions</button>
                <div class="control-item font-controls">
                    <span>Font Size:</span>
                    <button class="font-btn" id="fontDecrease">‚àí</button>
                    <span id="fontSize">12px</span>
                    <button class="font-btn" id="fontIncrease">+</button>
                </div>
            </div>
        </header>
        
        <!-- Debug Info Box (only shown with ?debug=true parameter) -->
        <div id="debugInfo" style="display: none; background: #fef3c7; border: 2px solid #f59e0b; padding: 15px; margin: 10px 20px; border-radius: 8px; font-family: monospace; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <strong style="color: #d97706;">üîç DEBUG INFO:</strong>
            <div style="margin-top: 8px;">
                <div><strong>Tuple ID:</strong> <span id="debugTupleId" style="color: #0891b2;"></span></div>
                <div><strong>Tuple Name:</strong> <span id="debugTupleName" style="color: #059669;"></span></div>
                <div><strong>Cluster:</strong> <span id="debugCluster" style="color: #0891b2;"></span></div>
                <div><strong>Pair Type:</strong> <span id="debugPairType" style="color: #7c3aed;"></span> | <strong>Pair ID:</strong> <span id="debugPairId" style="color: #7c3aed;"></span></div>
                <div><strong>V1 Metric:</strong> <span id="debugV1Metric" style="color: #dc2626;"></span> (<span id="debugV1Refactoring" style="color: #dc2626;"></span>)</div>
                <div><strong>V2 Metric:</strong> <span id="debugV2Metric" style="color: #dc2626;"></span> (<span id="debugV2Refactoring" style="color: #dc2626;"></span>)</div>
            </div>
        </div>
        
        <main class="study-main">
            <!-- Tab Navigation -->
            <div class="tab-navigation">
                <button class="tab-btn active" data-tab="original">Original Programs & Existing Functions</button>
                <button class="tab-btn" data-tab="refactorings">Refactorings (V1 vs V2)</button>
            </div>
            
            <!-- Tab Content: Original & Existing Functions -->
            <div class="tab-content active" id="originalTab">
                <div class="code-comparison two-pane">
                    <div class="code-panel">
                        <div class="panel-header">
                            <h3>Original Programs</h3>
                            <div class="view-buttons">
                                <button class="view-btn active" data-panel="original" data-view="all">ALL</button>
                                <button class="view-btn" data-panel="original" data-view="p1">P1</button>
                                <button class="view-btn" data-panel="original" data-view="p2">P2</button>
                                <button class="view-btn" data-panel="original" data-view="p3">P3</button>
                            </div>
                        </div>
                        <div class="code-wrapper">
                            <pre class="line-numbers"><code class="language-python" id="originalCode"></code></pre>
                        </div>
                    </div>
                    
                    <div class="code-panel">
                        <div class="panel-header">
                            <h3>Existing Functions (Retrieved)</h3>
                        </div>
                        <div class="code-wrapper">
                            <pre class="line-numbers"><code class="language-python" id="existingFunctionsCode"></code></pre>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab Content: Refactorings -->
            <div class="tab-content" id="refactoringsTab">
                <div class="code-comparison two-pane">
                    <div class="code-panel">
                        <div class="panel-header">
                            <h3>Version 1</h3>
                            <div class="view-buttons">
                                <button class="view-btn active" data-panel="v1" data-view="all">ALL</button>
                                <button class="view-btn" data-panel="v1" data-view="library">New Functions</button>
                                <button class="view-btn" data-panel="v1" data-view="p1">P1</button>
                                <button class="view-btn" data-panel="v1" data-view="p2">P2</button>
                                <button class="view-btn" data-panel="v1" data-view="p3">P3</button>
                            </div>
                        </div>
                        <div class="code-wrapper">
                            <pre class="line-numbers"><code class="language-python" id="v1Code"></code></pre>
                        </div>
                    </div>
                    
                    <div class="code-panel">
                        <div class="panel-header">
                            <h3>Version 2</h3>
                            <div class="view-buttons">
                                <button class="view-btn active" data-panel="v2" data-view="all">ALL</button>
                                <button class="view-btn" data-panel="v2" data-view="library">New Functions</button>
                                <button class="view-btn" data-panel="v2" data-view="p1">P1</button>
                                <button class="view-btn" data-panel="v2" data-view="p2">P2</button>
                                <button class="view-btn" data-panel="v2" data-view="p3">P3</button>
                            </div>
                        </div>
                        <div class="code-wrapper">
                            <pre class="line-numbers"><code class="language-python" id="v2Code"></code></pre>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="selection-section">
                <h3 style="text-align: center;">Which refactored version do you prefer?</h3>
                <div style="display: flex; gap: 2rem; align-items: flex-start; justify-content: center;">
                    <div style="flex: 0 0 auto;">
                        <div class="choice-buttons">
                            <button class="choice-btn" data-choice="v1" style="height: 45px; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 0.25rem 1rem;">
                                <span class="choice-label" style="font-size: 0.9rem;">Version 1</span>
                                <span class="shortcut" style="font-size: 0.7rem;">Press 1</span>
                            </button>
                            <button class="choice-btn" data-choice="v2" style="height: 45px; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 0.25rem 1rem;">
                                <span class="choice-label" style="font-size: 0.9rem;">Version 2</span>
                                <span class="shortcut" style="font-size: 0.7rem;">Press 2</span>
                            </button>
                        </div>
                    </div>
                    <div style="width: 500px; max-width: 100%;">
                        <textarea 
                            id="argumentText" 
                            placeholder="Explain why you chose this version over the other..."
                            style="width: 100%; height: 45px; min-height: 45px; padding: 0.5rem; border: 2px solid var(--border-color); border-radius: var(--radius); font-family: inherit; font-size: 0.85rem; resize: vertical;"
                        ></textarea>
                        <p style="margin-top: 0.25rem; font-size: 0.75rem; color: #dc2626; font-weight: 500;">
                            ‚ö†Ô∏è Both selection and explanation are required to continue
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="navigation">
                <button id="prevBtn" class="nav-btn" disabled>Previous</button>
                <button id="nextBtn" class="nav-btn btn-primary" disabled>Next Question</button>
                <button id="submitBtn" class="nav-btn btn-submit" style="display: none;">Complete Study</button>
            </div>
        </main>
        
    </div>
    
    <!-- Loading indicator -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Loading code...</p>
    </div>
    
    <!-- Modal for final submission -->
    <div class="modal" id="submitModal" style="display: none;">
        <div class="modal-content">
            <h2>Study Complete!</h2>
            <p>Thank you for completing the refactoring preference study.</p>
            
            <!-- Debug Summary (only shown with debug mode) -->
            <div id="debugSummaryContainer" style="display: none; background: #e0f2fe; border: 1px solid #0284c7; padding: 15px; margin: 20px 0; border-radius: 8px; max-height: 300px; overflow-y: auto;">
                <h3 style="color: #0284c7; margin-top: 0;">üìä Debug Summary - Your Choices:</h3>
                <div id="debugSummary" style="font-family: monospace; font-size: 12px;">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
            
            <p>Your responses have been saved. Click below to submit them via Google Forms.</p>
            <div class="modal-actions">
                <button id="openFormBtn" class="btn btn-primary" style="padding: 1rem 2rem; font-size: 1.2rem;">Submit Answers!</button>
            </div>
            <p class="note">The form will open with all your responses pre-filled. Just review and click Submit.</p>
        </div>
    </div>
    
    <!-- Instructions Modal -->
    <div class="modal" id="instructionsModal" style="display: none;">
        <div class="modal-content" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">
            <button class="close-btn" id="closeInstructionsBtn" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">√ó</button>
            
            <h2 style="margin-bottom: 1.5rem;">üìñ Study Instructions</h2>
            
            <div style="background: #f0f9ff; border: 1px solid #0284c7; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                <h3 style="color: #0369a1; margin-top: 0;">What You're Doing</h3>
                <p style="margin-bottom: 0.5rem;">A <strong>refactoring</strong> means splitting code into <strong>a library of reusable functions</strong> + <strong>shortened main programs</strong> that use those functions.</p>
                <p style="margin-bottom: 0.5rem;">You'll see <strong>two tabs</strong> at the top:</p>
                <ul style="margin-bottom: 0; padding-left: 20px;">
                    <li><strong>Tab 1 - Original Programs & Existing Functions:</strong> Shows the 3 original programs (solving related problems) and any existing helper functions that were already extracted</li>
                    <li><strong>Tab 2 - Refactorings (V1 vs V2):</strong> Shows two different refactoring approaches side by side for you to compare</li>
                </ul>
            </div>
            
            <div style="background: #e0f2fe; border: 2px solid #0284c7; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                <h3 style="margin-top: 0; color: #0c4a6e; margin-bottom: 1rem;">üìù Your Task (Both Required):</h3>
                <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 0.75rem;">
                    <div style="background: #0284c7; color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">1</div>
                    <div>
                        <strong style="color: #0c4a6e;">Choose which refactoring is better:</strong> Select Version 1 or Version 2
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <div style="background: #0284c7; color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">2</div>
                    <div>
                        <strong style="color: #0c4a6e;">Explain your choice:</strong> Write why you prefer one version over the other
                    </div>
                </div>
            </div>
            
            <div style="background: #fefce8; border: 1px solid #facc15; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                <h3 style="color: #a16207; margin-top: 0;">‚ö†Ô∏è Important Notes</h3>
                <p style="margin-bottom: 0.5rem;"><strong>Your task:</strong> Decide which refactoring is higher quality.</p>
                <p style="margin-bottom: 0.5rem;"><strong>Read problem statements:</strong> Look at the original programs (P1, P2, P3) to understand what problems they're solving. This will help you understand the purpose of the extracted functions.</p>
                <p style="margin-bottom: 0.5rem;"><strong>Focus on NEW functions and refactorings:</strong> Each library contains both existing extracted functions AND newly proposed functions. Consider the <strong>newly proposed functions</strong> and <strong>how the programs are refactored to use them</strong> when making your decision.</p>
                <p style="margin-bottom: 0;"><strong>Ignore documentation:</strong> Whether functions have docstrings or comments should NOT influence your choice. Focus only on the actual functionality of the code.</p>
            </div>
            
            <div style="background: #f9fafb; border: 1px solid #d1d5db; border-radius: 8px; padding: 1rem;">
                <h3 style="color: #374151; margin-top: 0;">How to Use the Interface</h3>
                <ul style="margin-bottom: 0; padding-left: 20px;">
                    <li><strong>Switch between tabs:</strong> Click the tabs at the top to toggle between "Original Programs & Existing Functions" and "Refactorings (V1 vs V2)"</li>
                    <li><strong>View buttons in each panel:</strong></li>
                    <ul style="padding-left: 20px;">
                        <li><strong>ALL:</strong> Shows the complete refactored code including both the library and all three programs</li>
                        <li><strong>New Functions:</strong> Shows only the newly proposed functions (excluding retrieved/existing functions)</li>
                        <li><strong>P1, P2, P3:</strong> Shows how each individual program uses the library functions</li>
                    </ul>
                    <li><strong>Make your choice:</strong> Click either "Version 1" or "Version 2" button (or press keyboard keys 1 or 2) to select which refactoring you prefer</li>
                    <li><strong>Explain your choice:</strong> You MUST write an explanation in the text box arguing why you chose one version over the other. This is required to continue.</li>
                    <li><strong>Navigate:</strong> Use "Next Question" to proceed after making a selection AND providing an explanation</li>
                    <li><strong>Adjust font size:</strong> Use the + and - buttons in the header to make text larger or smaller</li>
                </ul>
            </div>
            
            <button class="btn btn-primary" id="closeInstructionsBtn2" style="margin-top: 1.5rem; width: 100%;">Got it, close instructions</button>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
    <script src="js/study_single_form.js"></script>
</body>
</html>